name: Build and lint

on:
  - push
  - pull_request

jobs:
  code-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Install clang tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy cmake
          
      - name: Check code format
        run: |
          find . -name "*.c" -o -name "*.h" -type f | xargs clang-format --style=file --dry-run -Werror
      
      - name: Detect CMake configuration
        id: cmake-check
        run: |
          if [ -f "CMakeLists.txt" ]; then
            echo "cmake_detected=true" >> $GITHUB_OUTPUT
          else
            echo "cmake_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Full CMake analysis
        if: steps.cmake-check.outputs.cmake_detected == 'true'
        run: |
          cmake . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cmake --build build
          run-clang-tidy -p=build

      - name: Basic analysis (no CMake)
        if: steps.cmake-check.outputs.cmake_detected == 'false'
        run: |
          find . -name "*.c" -o -name "*.h" -type f | xargs clang-tidy --config-file=.clang-tidy --